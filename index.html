<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive Story</title>

<style>
  body {
    background: black;
    color: white;
    font-family: monospace;
    padding: 20px;
  }

  p {
    margin-bottom: 30px;
    line-height: 1.5;
  }

  .choice {
    display: block;
    margin-top: 15px;
    cursor: pointer;
  }

  /* LETTER CRUMBLE EFFECT */
  .crumble-text .letter {
    display: inline-block;
    transition: transform 1s ease-out;
    opacity: 1;
  }

  .crumble-text .letter.scatter {
    transform: translate(
      calc(var(--randX) * 200px),
      calc(var(--randY) * 200px)
    )
    rotate(calc(var(--randR) * 360deg))
    scale(calc(0.5 + var(--randS)));
    opacity: 0;
  }

  /* IMPORTANT FIX â€” removed height:1em */
  .crumble-text {
    display: inline-block;
    position: relative;
    white-space: nowrap;
  }

  /* GLITCH LAYERS */
  .glitch-wrapper {
    position: relative;
    display: inline-block;
  }
  .glitch-layer {
    position: absolute;
    top: 0; left: 0;
    opacity: 0.2;
    mix-blend-mode: screen;
  }
  .glitch-layer.red { color: red; transform: translate(1px,0); }
  .glitch-layer.green { color: green; transform: translate(-1px,0); }
  .glitch-layer.blue { color: blue; transform: translate(0,1px); }

</style>

</head>
<body>

<div id="passage"></div>

<script>
/* ===============================
   STORY OBJECT
================================*/
const story = {
  start: {
    text: "You are in your kitchen...",
    choices: [
      { text: "Look at the dishes", next: "dishes" },
      { text: "Open the fridge", next: "fridge" }
    ]
  },

  dishes: {
    text: "The dishes are stacked and wet.",
    choices: [
      { text: "Touch the blood", next: "blood" },
      { text: "Go back", next: "start" }
    ]
  },

  blood: {
    text: "It's warm.",
    choices: [
      { text: "Eat cake", next: "cake" }
    ]
  },

  fridge: {
    text: "The fridge is humming.",
    choices: [
      { text: "Look deeper", next: "fridge2" },
      { text: "Leave", next: "start" }
    ]
  },

  fridge2: {
    text: "You see something moving.",
    choices: [
      { text: "Follow it", next: "hallway" }
    ]
  },

  cake: {
    text: "The cake tastes metallic.",
    choices: [
      { text: "Keep eating", next: "eat" }
    ]
  },

  hallway: {
    text: "The hallway stretches endlessly.",
    choices: [
      { text: "Go to stairs", next: "stairs" }
    ]
  },

  stairs: {
    text: "The stairs spiral downward.",
    choices: [
      { text: "Take elevator", next: "elevator" }
    ]
  },

  elevator: {
    text: "You hear the cables strain.",
    choices: [
      { text: "Enter", next: "ending" }
    ]
  },

  eat: {
    text: "You keep swallowing.",
    choices: [
      { text: "Keep going", next: "ending" }
    ]
  },

  ending: {
    text: "Everything crumbles around you.",
    choices: []
  }
};


/* ===============================
   TEXT SPLITTING + CRUMBLE EFFECT
================================*/
function splitIntoLetters(text) {
  return [...text].map(l => {
    if (l === " ") l = "&nbsp;";
    return `<span class="letter">${l}</span>`;
  }).join('');
}

function startCrumbleEffect(delay = 1000) {
  const letters = document.querySelectorAll('.crumble-text .letter');

  letters.forEach(el => {
    el.style.setProperty('--randX', (Math.random() - 0.5) * 2);
    el.style.setProperty('--randY', (Math.random() - 0.5) * 2);
    el.style.setProperty('--randR', (Math.random() - 0.5) * 2);
    el.style.setProperty('--randS', Math.random());

    const duration = 40 + Math.random() * 40;
    el.style.animationDuration = duration + 's';

    const animDelay = Math.random() * 20;
    el.style.animationDelay = animDelay + 's';
  });

  setTimeout(() => {
    letters.forEach(el => el.classList.add('scatter'));
  }, delay);
}


/* ===============================
   GLITCH WRAPPER
================================*/
function createGlitchWrapper(htmlContent, isBlock=false) {
  const blockClass = isBlock ? ' block' : '';
  return `
    <span class="glitch-wrapper${blockClass}">
      <span class="top-layer">${htmlContent}</span>
      <span class="glitch-layer red">${htmlContent}</span>
      <span class="glitch-layer green">${htmlContent}</span>
      <span class="glitch-layer blue">${htmlContent}</span>
    </span>
  `;
}

function createChoiceHTML(choice) {
  return `<span class="choice">${createGlitchWrapper(choice.text, true)}</span>`;
}


/* ===============================
   RENDER FUNCTION
================================*/
function render(passageName) {
  const p = story[passageName];
  const container = document.getElementById("passage");

  let mainTextHTML;
  if (passageName === "ending") {
    const split = splitIntoLetters(p.text);
    mainTextHTML = createGlitchWrapper(`<span class="crumble-text">${split}</span>`);
  } else {
    mainTextHTML = createGlitchWrapper(`<span>${p.text}</span>`);
  }

  let html = `<p>${mainTextHTML}</p>`;

  p.choices.forEach(c => {
    html += createChoiceHTML(c);
  });

  container.innerHTML = html;

  const choiceElements = container.querySelectorAll('.choice');
  choiceElements.forEach((el, idx) => {
    el.addEventListener('click', () => {
      render(p.choices[idx].next);
    });
  });

  /* crumble effect */
  if (passageName === "ending") startCrumbleEffect(1000);

  /* restart story on tap for iPad */
  if (passageName === "ending") {
    const restartHandler = () => {
      document.body.removeEventListener('touchstart', restartHandler);
      document.body.removeEventListener('click', restartHandler);
      render("start");
    };

    document.body.addEventListener('touchstart', restartHandler, { passive: true, capture: true });
    document.body.addEventListener('click', restartHandler, { capture: true });
  }
}

/* START */
render("start");
</script>

</body>
</html>
